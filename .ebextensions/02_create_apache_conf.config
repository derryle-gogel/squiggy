#
# Apache configuration files and keys.
#
files:
  /tmp/ssl.conf:
    mode: '000644'
    owner: root
    group: root
    content: |
      <VirtualHost *:80>
        <Proxy *>
          Require all granted
        </Proxy>

        # Allow cross-origin calls from any website. This is required for the bookmarklet tool.
        Header set Access-Control-Allow-Origin "*"

        ProxyPreserveHost on
        RewriteEngine on

        LogLevel INFO rewrite:trace3
        LogLevel INFO proxy:trace3

        RewriteCond %{HTTP:Upgrade} websocket [NC]
        RewriteCond %{HTTP:Connection} upgrade [NC]
        RewriteRule .* "ws://localhost:8000%{REQUEST_URI}" [P]

        RewriteEngine on
        RewriteCond %{QUERY_STRING}        transport=websocket
        RewriteRule /(.*)$                 ws://localhost:8000/$1 [P]

        RewriteEngine on
        RewriteCond %{QUERY_STRING}        transport=polling
        RewriteRule /(.*)$                 ws://localhost:8000/$1 [P]

        # Proxy websocket connections
        ProxyPass         /socket.io/   ws://localhost:8000/socket.io/
        ProxyPassReverse  /socket.io/   ws://localhost:8000/socket.io/

        ProxyPass / http://localhost:8000/ retry=0
        ProxyPassReverse / http://localhost:8000/
      </VirtualHost>